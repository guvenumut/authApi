<%- include('partials/header'); -%>

<form id="passwordForm">
  <h2>Sifre Degistir</h2>
  <label for="password">Password</label>
  <input type="password" name="password" id="password" required />
  <div class="passworderror"></div>
  <label for="rePassword">rePassword</label>
  <input type="password" name="rePassword" id="rePassword" required />
  <div class="rePassworderror"></div>
  <!-- Gizli input alanı -->
  <input type="hidden" name="token" value="<%= token %>" />
  <button type="submit">Onayla</button>
</form>

<%- include('partials/footer'); -%>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#passwordForm');
    const passwordError = document.querySelector('.password.error');
    const rePasswordError = document.querySelector('.rePassword.error');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // reset errors
      passwordError.textContent = '';
      rePasswordError.textContent = '';

      // get values
      const password = form.password.value;
      const rePassword = form.rePassword.value;
      const token = form.token.value; // token'ı da al

      try {
        const res = await fetch('/passwordreset/reset', { 
          method: 'POST', 
          body: JSON.stringify({ password, rePassword, token }), // token'ı gönder
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        if (data.errors) {
          if (data.errors.email) {
            passworderror.textContent = data.errors.email;
          }
          if (data.errors.password) {
            rePassworderror.textContent = data.errors.password;
          }
        }
        if (data.message) {
          alert(data.message);
          location.assign('/');
        }

      } catch (err) {
        console.log(err);
      }
    });
  });
</script>
